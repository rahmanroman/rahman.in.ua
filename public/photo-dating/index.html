<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Quick Dating</title>

<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

<style type="text/css">
body {font:normal 9pt/1 "Lucida Sans Unicode", "Lucida Grande", sans-serif;}

.ui {text-align:center;}
h1 {text-transform:capitalize; margin:0; padding:0;}

#user {display:none; margin-bottom:1em;}
#user img {margin-botom:1em;}

.loading {position:absolute; left:0; top:0; right:0; bottom:0; z-index:1000; opacity:.5; background:#000; color:#fff; display:none;}
.loading h1 {text-align:center; margin-top:2em;}
</style>

</head>

<body>
	<div class="ui">
		<div id="user">
			<img src="javascript:void" id="thumbnail">
			<h1 id="face"></h1>
			<h1 id="place"></h1>
		</div>
		
		<input type="file" accept="image/*;capture=camera" id="photo">
		

		<textarea style="width:100%; height:300px; display:none;" id="debug"></textarea>
	</div>
	
	<div class="loading"><h1>Please wait...</h1></div>
	
<script src="http://yandex.st/jquery/2.0.2/jquery.min.js"></script>

<script src="scripts/load-image/load-image.js"></script>
<script src="scripts/load-image/load-image-ios.js"></script>
<script src="scripts/load-image/load-image-orientation.js"></script>
<script src="scripts/load-image/load-image-meta.js"></script>
<script src="scripts/load-image/load-image-exif.js"></script>
<script src="scripts/load-image/load-image-exif-map.js"></script>


<script>
// http://davidwalsh.name/browser-camera
// http://www.html5rocks.com/en/tutorials/getusermedia/intro/

$('#photo').change(function(event) {
	var input = event.target, files = input.files, photo = files[0];
	
	loadImage.parseMetaData(photo, function(data) {
		var exif = data.exif.getAll();
		
		var lat = str2double(exif['GPSLatitude']);
		var lng = str2double(exif['GPSLongitude']);
		
		$('.loading').fadeIn(100);
		$.when(get_geo_data(lat, lng), get_face_data(photo)).then(function(geo, face) {
			$('.loading').fadeOut(100);
			show_user(data.exif, geo, face);
		});
	});
	
});

function show_user(exif, geo, face) {
	$('#thumbnail').attr('src', exif.Thumbnail);
	$('#place').text([geo.country, geo.city].join(', '));
	$('#face').text([face.gender, face.age].join(', '));
	
	$('#user').fadeIn(200);
};

function str2double(str) {
	if(str) {
		var data = str.split(',');
		return parseFloat(data[0]) + parseFloat(data[1])/60 + parseFloat(data[2])/3600;
	} else {
		return null;
	}
};

function get_geo_data(lat, lng) {
	return $.ajax({
		url:	'http://maps.googleapis.com/maps/api/geocode/json',
		data:	{
			latlng:	(lat + ',' + lng),
			sensor:	true
		}
	}).then(function(data) {
		return parse_geo_data(data);
	});
};

function log(data) {
	$('#debug').val(JSON.stringify(data, true));
};

function parse_geo_data(geodata) {
	var result = {
		country:	'',
		city:		''
	};
	
	if(geodata.status == 'OK' && geodata.results.length > 0) {
		var component, type, result0 = geodata.results[0];
		for(var i=0; i<result0.address_components.length; i++) {
			component = result0.address_components[i];
			
			if($.isArray(component.types) && component.types.length > 0) {
				switch(component.types[0]) {
					case 'locality':
						result.city = component.long_name;
						break;
					
					case 'country':
						result.country = component.long_name;
						break;
				}
			}
			
		}
	}

	return result
};

function get_face_data(file) {
	var params = {
		// Specify your subscription key
		'subscription-key': '1ca394b0cc064c8685a399be832967df',
		// Specify values for optional parameters, as needed
		//analyzesFaceLandmarks: "false",
		analyzesAge: "true",
		analyzesGender: "true",
		// analyzesHeadPose: "false",
	};
	
	return $.ajax({
		url: 'https://api.projectoxford.ai/face/v0/detections?' + $.param(params),
		type: 'POST',
		data: file,
		contentType: 'application/octet-stream',
        processData: false
	
//		contentType: 'application/json',
//		data:	'{"url":"http://how-old.net/Images/faces2/scroll003.jpg"}',
//		processData: false
	})
	.then(function(data) {
		if(data && $.isArray(data) && data.length > 0 && data[0].attributes) {
			return data[0].attributes
		}
		return {
			gender:	'Unknown',
			age:	0
		};
	});	
};
</script>
</body>
</html>
